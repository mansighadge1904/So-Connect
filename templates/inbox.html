<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-ENjdO4Dr2bkBIFxQpeo6lYE1Fhb8QvE1QZr4lG1ZT13GpV8CvH+KkV9MuGxw66u2" crossorigin="anonymous">
{% extends 'base.html' %}

{% block content %}
<style>
    .chat-container {
        height: 75vh;
        display: flex;
        border-radius: 10px;
        overflow: hidden;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        background: #fff;
        margin-top: 20px;
        width: 100%;  /* Increase the width of the chat container */
        max-width: 1200px; /* Optional: You can set a maximum width */
        margin-left: auto;
        margin-right: auto;
    }
    .user-list {
        width: 30%;
        background: #f7f7f7;
        border-right: 1px solid #ddd;
        overflow-y: auto;
        padding: 10px;
    }
    .user {
        padding: 15px;
        border-bottom: 1px solid #eee;
        cursor: pointer;
        font-weight: 500;
        color: #333;
    }
    .user:hover, .user.active {
        background: #e0e0e0;
        color: white;
    }
    .chat-box {
        width: 70%;
        display: flex;
        flex-direction: column;
        background: #fafafa;
    }
    .messages {
        flex-grow: 1;
        padding: 20px;
        overflow-y: auto;
        background: #fafafa;
    }
    .message {
        margin-bottom: 15px;
        max-width: 60%;
        padding: 10px 18px;
        border-radius: 20px;
        word-wrap: break-word;
        font-size: 14px;
    }
    .sent {
        background: #cce5ff;
        margin-left: auto;
        border-radius: 20px 20px 0 20px;
        color: #004085;
    }
    .received {
        background: #f8d7da;
        margin-right: auto;
        border-radius: 20px 20px 20px 0;
        color: #721c24;
    }
    .chat-input {
        padding: 15px;
        border-top: 1px solid #ddd;
        background: #fff;
        display: flex;
        align-items: center;
    }
    .chat-input .input-group {
        width: 100%;
    }
    .chat-input-box {
        border-radius: 25px 0 0 25px;
        padding: 10px;
        font-size: 14px;
        border: 1px solid #ddd;
        box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
        width: 85%;
    }

    .chat-send-btn {
        border-radius: 0 25px 25px 0;
        padding: 10px 20px;
        font-size: 14px;
        background-color: #007bff;
        color: white;
        border: 1px solid #007bff;
        cursor: pointer;
    }

    .chat-send-btn:hover {
        background-color: #0056b3;
        border-color: #0056b3;
    }
    .input-group input {
        border-radius: 25px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .input-group button {
        border-radius: 25px;
        background-color: #007bff;
        color: white;
    }

    .input-group button:hover {
        background-color: #0056b3;
    }

    .chat-sidebar-item {
        padding: 10px;
        cursor: pointer;
        margin-bottom: 8px;
        border-radius: 8px;
        transition: background-color 0.3s ease;
    }
    .chat-sidebar-item:hover {
        background-color: #e6f7ff;
    }
</style>

<div class="container my-4">
    <div class="chat-container">
        <!-- User list -->
        <div class="user-list list-group">
            {% for user_item in messages %}
                <div class="chat-sidebar-item">
                    <button class="btn btn-link" onclick="selectUser('{{ user_item.user.username }}')">
                        {{ user_item.user.username }}
                    </button>
                </div>
            {% endfor %}
        </div>

        <!-- Chat area -->
        <div class="chat-box">
            <div class="messages">
                {% for direct in directs %}
                    {% if direct.sender == request.user %}
                        <div class="message sent">{{ direct.body }}</div>
                    {% else %}
                        <div class="message received">{{ direct.body }}</div>
                    {% endif %}
                {% endfor %}
            </div>
            <div class="chat-input">
                <form method="post" id="chat-form">
                    {% csrf_token %}
                    <div class="input-group">
                        <!-- Hidden input to store the selected recipient's username -->
                        <input type="hidden" name="to_user" id="to_user" value="{{ active_direct }}">
                        <input type="text" class="form-control" name="body" placeholder="Type a message..." required>
                        <button class="btn btn-primary" type="submit">Send</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    $(document).ready(function() {
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        
        const csrftoken = getCookie('csrftoken');

        $('#chat-form').submit(function(e) {
            e.preventDefault();
            console.log("Form submitted!");

            // Make sure to include the selected user (to_user) in the data sent by AJAX
            $.ajax({
                type: 'POST',
                url: window.location.href,  // URL for the current page (inbox)
                data: $(this).serialize(),   // Serialize the form data, including 'to_user' and 'body'
                headers: { 'X-CSRFToken': csrftoken },
                success: function(response) {
                    console.log(response.message);  // Log the success message (can be customized)
                    location.reload();  // Reload the page after sending the message
                },
                error: function(xhr, status, error) {
                    console.error("Error:", error);
                    alert('Error sending message!');  // Show an error alert if something goes wrong
                }
            });
        });
    });
</script>



{% endblock %}
